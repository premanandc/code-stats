---
name: "Release"
"on":
  push:
    tags:
    - "v*"
permissions:
  contents: "write"
jobs:
  release:
    runs-on: "ubuntu-latest"
    steps:
    - name: "Checkout code"
      uses: "actions/checkout@v4"
    - name: "Set up JDK 17"
      uses: "actions/setup-java@v4"
      with:
        java-version: "17"
        distribution: "temurin"
    - name: "Cache Maven packages"
      uses: "actions/cache@v4"
      with:
        path: "~/.m2"
        key: "${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}"
        restore-keys: "${{ runner.os }}-m2"
    - name: "Run security and quality checks"
      run: "./mvnw clean verify -B\n"
    - name: "Build release JAR"
      run: "./mvnw clean package -B -DskipTests\n"
    - name: "Get version from tag"
      id: "version"
      run: "echo \"VERSION=${GITHUB_REF#refs/tags/v}\" >> $GITHUB_OUTPUT"
    - name: "Create Release"
      id: "create_release"
      uses: "actions/create-release@v1"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      with:
        tag_name: "${{ github.ref }}"
        release_name: "Code Stats v${{ steps.version.outputs.VERSION }}"
        body: "## Changes in v${{ steps.version.outputs.VERSION }}\n\n### Features\n\
          - Git repository statistics analysis\n- Contributor activity insights\n\
          - Language-specific code breakdowns\n- Production vs test code separation\n\
          - Email alias resolution for multiple contributor identities\n- Flexible\
          \ date filtering and user filtering\n- JSON and colored terminal output\n\
          - YAML configuration file support\n\n### Security\n- ✅ Static Application\
          \ Security Testing (SAST) with SpotBugs + FindSecBugs\n- ✅ Software Composition\
          \ Analysis (SCA) with OWASP Dependency-Check\n- ✅ All dependencies scanned\
          \ for CVE vulnerabilities\n- ✅ Build fails on security vulnerabilities (CVSS\
          \ ≥ 7.0)\n\n### Download\nDownload the `code-stats-${{ steps.version.outputs.VERSION\
          \ }}.jar` file below and run with:\n```bash\njava -jar code-stats-${{ steps.version.outputs.VERSION\
          \ }}.jar\n```\n\n### Requirements\n- Java 17 or later\n- Git (accessible\
          \ from command line)\n\nSee the [README](https://github.com/premanandc/code-stats/blob/main/README.md)\
          \ for usage instructions.\n"
        draft: false
        prerelease: false
    - name: "Upload Release Asset"
      uses: "actions/upload-release-asset@v1"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      with:
        upload_url: "${{ steps.create_release.outputs.upload_url }}"
        asset_path: "./target/code-stats-1.0.0.jar"
        asset_name: "code-stats-${{ steps.version.outputs.VERSION }}.jar"
        asset_content_type: "application/java-archive"
    - name: "Upload Security Reports"
      uses: "actions/upload-release-asset@v1"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      with:
        upload_url: "${{ steps.create_release.outputs.upload_url }}"
        asset_path: "./target/dependency-check-report.html"
        asset_name: "security-report-${{ steps.version.outputs.VERSION }}.html"
        asset_content_type: "text/html"
